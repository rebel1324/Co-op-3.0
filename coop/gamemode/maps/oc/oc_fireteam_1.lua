-- OBSIDIAN CONFLICT OFFICIAL MAP
--[[
	PASTE TEXT HERE

]]
MAP_BREIFING = [[Obsidian Conflict

Map: oc_fireteam_1
Author: Tysn

Description:

After receiving a distress signal from a nearby rebel outpost, you are to use the jeep to make your way over there and help defend them.
]]

MODIFY_REMOVE =[[
            "-329.88 -3437.13 108.315" {}
            "-290.146 -3819.82 129.761" {}
            "-304.86 -3952.76 117.611" {}
            "-301.354 -3641.88 125.521" {}
            "-493.147 -3971.65 108.318" {}
            ]]
MODIFY_ADD = [[
     "prop_dynamic_override"
        {
            "angles" "-2.75581 11.2134 8.62872"
            "disablereceiveshadows" "0"
            "disableshadows" "0"
            "ExplodeDamage" "0"
            "ExplodeRadius" "0"
            "fademaxdist" "0"
            "fademindist" "-1"
            "fadescale" "1"
            "health" "0"
            "MaxAnimTime" "10"
            "maxdxlevel" "0"
            "MinAnimTime" "5"
            "mindxlevel" "0"
            "model" "models/props_vehicles/van001a.mdl"
            "PerformanceMode" "0"
            "pressuredelay" "0"
            "RandomAnimation" "0"
            "renderamt" "255"
            "rendercolor" "255 255 255"
            "renderdist" "0"
            "renderfx" "0"
            "rendermode" "0"
            "SetBodyGroup" "0"
            "skin" "0"
            "solid" "6"
            "spawnflags" "0"
            "origin" "-1696 4199 38"
        }
        "item_ammo_crate"
        {
            "AmmoType" "9"
            "angles" "0.216423 204.976 -12.4982"
            "fademaxdist" "0"
            "fademindist" "-1"
            "fadescale" "1"
            "origin" "-1687 4157 20"
        }
        "item_item_crate"
        {
            "angles" "0 336 0"
            "CrateAppearance" "0"
            "CrateType" "0"
            "damagetoenablemotion" "0"
            "Damagetype" "0"
            "disableshadows" "0"
            "ExplodeDamage" "0"
            "ExplodeRadius" "0"
            "fademaxdist" "0"
            "fademindist" "-1"
            "fadescale" "1"
            "forcetoenablemotion" "0"
            "inertiaScale" "1.0"
            "ItemClass" "item_battery"
            "ItemCount" "2"
            "ManageItems" "0"
            "massScale" "0"
            "maxdxlevel" "0"
            "mindxlevel" "0"
            "minhealthdmg" "0"
            "nodamageforces" "0"
            "PerformanceMode" "0"
            "physdamagescale" "0.1"
            "pressuredelay" "0"
            "shadowcastdist" "0"
            "skin" "0"
            "spawnflags" "1073741824"
            "origin" "-1760 4113 1"
        }
        "npc_turret_floor"
        {
            "angles" "0 270 0"
            "hammerid" "81396"
            "model" "models/combine_turrets/floor_turret.mdl"
            "spawnflags" "0"
            "origin" "-2049 -1442 90"
        }
        "combine_mine"
        {
            "angles" "0 326 0"
            "bounce" "1"
            "LockSilently" "1"
            "Modification" "0"
            "StartDisarmed" "0"
            "origin" "-1684 4089 7.92721"
        }
        "combine_mine"
        {
            "angles" "0 249.5 0"
            "bounce" "1"
            "LockSilently" "1"
            "Modification" "0"
            "StartDisarmed" "0"
            "origin" "-1764 4051 7.91841"
        }
        "combine_mine"
        {
            "angles" "0 263.5 0"
            "bounce" "1"
            "LockSilently" "1"
            "Modification" "0"
            "StartDisarmed" "0"
            "origin" "-1588 4105 8.21873"
        }
        "npc_turret_floor"
        {
            "angles" "0 254 0"
            "hammerid" "81396"
            "model" "models/combine_turrets/floor_turret.mdl"
            "spawnflags" "0"
            "origin" "-1720 4118 2"
        }
        "prop_physics"
        {
            "angles" "0 270 0"
            "damagetoenablemotion" "0"
            "Damagetype" "0"
            "disablereceiveshadows" "0"
            "disableshadows" "0"
            "ExplodeDamage" "0"
            "ExplodeRadius" "0"
            "fademaxdist" "0"
            "fademindist" "-1"
            "fadescale" "1"
            "forcetoenablemotion" "0"
            "inertiaScale" "1.0"
            "massScale" "0"
            "maxdxlevel" "0"
            "mindxlevel" "0"
            "minhealthdmg" "0"
            "model" "models/props_c17/oildrum001_explosive.mdl"
            "nodamageforces" "0"
            "PerformanceMode" "0"
            "physdamagescale" "0.1"
            "pressuredelay" "0"
            "renderamt" "255"
            "rendercolor" "255 255 255"
            "renderdist" "0"
            "renderfx" "0"
            "rendermode" "0"
            "shadowcastdist" "0"
            "skin" "0"
            "spawnflags" "256"
            "origin" "-1537.29 4151 5"
        }
        "npc_turret_floor"
        {
            "angles" "0 315 0"
            "hammerid" "81396"
            "model" "models/combine_turrets/floor_turret.mdl"
            "spawnflags" "0"
            "origin" "-1763 -5917 131"
        }
        "npc_turret_floor"
        {
            "angles" "0 188.5 0"
            "hammerid" "81396"
            "model" "models/combine_turrets/floor_turret.mdl"
            "spawnflags" "0"
            "origin" "-3185 -9261 34"
        }
        "prop_physics"
        {
            "angles" "0 240 0"
            "damagetoenablemotion" "0"
            "Damagetype" "0"
            "disablereceiveshadows" "0"
            "disableshadows" "0"
            "ExplodeDamage" "0"
            "ExplodeRadius" "0"
            "fademaxdist" "2000"
            "fademindist" "1750"
            "fadescale" "1"
            "forcetoenablemotion" "0"
            "hammerid" "51111"
            "inertiaScale" "1.0"
            "massScale" "0"
            "maxdxlevel" "0"
            "mindxlevel" "0"
            "minhealthdmg" "0"
            "model" "models/props_c17/oildrum001_explosive.mdl"
            "nodamageforces" "0"
            "PerformanceMode" "0"
            "physdamagescale" "0.1"
            "pressuredelay" "0"
            "renderamt" "255"
            "rendercolor" "255 255 255"
            "renderfx" "0"
            "rendermode" "0"
            "shadowcastdist" "0"
            "skin" "0"
            "spawnflags" "257"
            "origin" "-3200 -9315 33"
        }
        "weapon_scripted"
        {
            "angles" "0 15.5 -90"
            "customweaponscript" "custom_oicw"
            "fademaxdist" "0"
            "fademindist" "-1"
            "fadescale" "1"
            "minplayerstospawn" "0"
            "spawnflags" "-1073741824"
            "origin" "-6730.95 -9523.15 69"
        }
        "item_ammo_smg1"
        {
            "angles" "0 276.5 0"
            "disableshadows" "0"
            "fademaxdist" "0"
            "fademindist" "-1"
            "fadescale" "1"
            "minplayerstospawn" "0"
            "spawnflags" "-1073741824"
            "origin" "-6734.75 -9507.48 67"
        }
        "item_ammo_smg1"
        {
            "angles" "0 267 0"
            "disableshadows" "0"
            "fademaxdist" "0"
            "fademindist" "-1"
            "fadescale" "1"
            "minplayerstospawn" "0"
            "spawnflags" "-1073741824"
            "origin" "-6713 -9504 67"
        }
        "weapon_scripted"
        {
            "angles" "0 99 -90"
            "customweaponscript" "custom_spas12"
            "fademaxdist" "0"
            "fademindist" "-1"
            "fadescale" "1"
            "minplayerstospawn" "0"
            "spawnflags" "-1073741823"
            "origin" "-2094 -2297 -1244"
        }
        "item_box_buckshot"
        {
            "angles" "0 337.5 0"
            "disableshadows" "0"
            "fademaxdist" "0"
            "fademindist" "-1"
            "fadescale" "1"
            "minplayerstospawn" "0"
            "spawnflags" "-1073741823"
            "origin" "-2110 -2287 -1246"
        }
        "item_box_buckshot"
        {
            "angles" "0 22 0"
            "disableshadows" "0"
            "fademaxdist" "0"
            "fademindist" "-1"
            "fadescale" "1"
            "minplayerstospawn" "0"
            "spawnflags" "-1073741823"
            "origin" "-2110 -2301 -1246"
        }
        "prop_dynamic_override"
        {
            "angles" "0 306 0"
            "disablereceiveshadows" "0"
            "disableshadows" "0"
            "ExplodeDamage" "0"
            "ExplodeRadius" "0"
            "fademaxdist" "0"
            "fademindist" "-1"
            "fadescale" "1"
            "health" "0"
            "MaxAnimTime" "10"
            "maxdxlevel" "0"
            "MinAnimTime" "5"
            "mindxlevel" "0"
            "model" "models/props_wasteland/rockcliff_cluster03c.mdl"
            "PerformanceMode" "0"
            "pressuredelay" "0"
            "RandomAnimation" "0"
            "renderamt" "255"
            "rendercolor" "255 255 255"
            "renderdist" "0"
            "renderfx" "0"
            "rendermode" "0"
            "SetBodyGroup" "0"
            "skin" "0"
            "solid" "6"
            "spawnflags" "0"
            "origin" "-485 -4001 215"
        }
        "npc_turret_floor"
        {
            "angles" "0 101.5 0"
            "hammerid" "81396"
            "model" "models/combine_turrets/floor_turret.mdl"
            "spawnflags" "0"
            "origin" "-277 -4005 89"
        }
        "npc_turret_floor"
        {
            "angles" "0 88.5 0"
            "hammerid" "81396"
            "model" "models/combine_turrets/floor_turret.mdl"
            "spawnflags" "0"
            "origin" "-316 -4005 88"
        }
        "prop_dynamic_override"
        {
            "angles" "0 197 0"
            "disablereceiveshadows" "0"
            "disableshadows" "0"
            "ExplodeDamage" "0"
            "ExplodeRadius" "0"
            "fademaxdist" "0"
            "fademindist" "-1"
            "fadescale" "1"
            "health" "0"
            "MaxAnimTime" "10"
            "maxdxlevel" "0"
            "MinAnimTime" "5"
            "mindxlevel" "0"
            "model" "models/props_wasteland/rockcliff05a.mdl"
            "PerformanceMode" "0"
            "pressuredelay" "0"
            "RandomAnimation" "0"
            "renderamt" "255"
            "rendercolor" "255 255 255"
            "renderdist" "0"
            "renderfx" "0"
            "rendermode" "0"
            "SetBodyGroup" "0"
            "skin" "0"
            "solid" "6"
            "spawnflags" "0"
            "origin" "-265 -3666 105"
        }
        "prop_dynamic_override"
        {
            "angles" "-73 9 -90"
            "disablereceiveshadows" "0"
            "disableshadows" "0"
            "ExplodeDamage" "0"
            "ExplodeRadius" "0"
            "fademaxdist" "0"
            "fademindist" "-1"
            "fadescale" "1"
            "health" "0"
            "MaxAnimTime" "10"
            "maxdxlevel" "0"
            "MinAnimTime" "5"
            "mindxlevel" "0"
            "model" "models/props_wasteland/rockgranite02a.mdl"
            "PerformanceMode" "0"
            "pressuredelay" "0"
            "RandomAnimation" "0"
            "renderamt" "255"
            "rendercolor" "255 255 255"
            "renderdist" "0"
            "renderfx" "0"
            "rendermode" "0"
            "SetBodyGroup" "0"
            "skin" "0"
            "solid" "6"
            "spawnflags" "0"
            "origin" "-358 -3529 98"
        }
        "weapon_scripted"
        {
            "angles" "0 211 -90"
            "customweaponscript" "custom_g36c"
            "fademaxdist" "0"
            "fademindist" "-1"
            "fadescale" "1"
            "minplayerstospawn" "0"
            "spawnflags" "-1073741824"
            "origin" "-157 -3961 129"
        }
        "item_ammo_ar2"
        {
            "angles" "0 212 90"
            "disableshadows" "0"
            "fademaxdist" "0"
            "fademindist" "-1"
            "fadescale" "1"
            "minplayerstospawn" "0"
            "spawnflags" "-1073741824"
            "origin" "-139 -3987 107"
        }
        "item_item_crate"
        {
            "angles" "0 38 0"
            "CrateAppearance" "0"
            "CrateType" "0"
            "damagetoenablemotion" "0"
            "Damagetype" "0"
            "disableshadows" "0"
            "ExplodeDamage" "0"
            "ExplodeRadius" "0"
            "fademaxdist" "0"
            "fademindist" "-1"
            "fadescale" "1"
            "forcetoenablemotion" "0"
            "inertiaScale" "1.0"
            "ItemClass" "item_battery"
            "ItemCount" "2"
            "ManageItems" "0"
            "massScale" "0"
            "maxdxlevel" "0"
            "mindxlevel" "0"
            "minhealthdmg" "0"
            "nodamageforces" "0"
            "PerformanceMode" "0"
            "physdamagescale" "0.1"
            "pressuredelay" "0"
            "shadowcastdist" "0"
            "skin" "0"
            "spawnflags" "1073741824"
            "origin" "-170 -3966 101.245"
        }
        "item_ammo_ar2"
        {
            "angles" "0 266.5 90"
            "disableshadows" "0"
            "fademaxdist" "0"
            "fademindist" "-1"
            "fadescale" "1"
            "minplayerstospawn" "0"
            "spawnflags" "-1073741824"
            "origin" "-168 -3932 107"
        }
        "item_ammo_ar2"
        {
            "angles" "0 162 90"
            "disableshadows" "0"
            "fademaxdist" "0"
            "fademindist" "-1"
            "fadescale" "1"
            "minplayerstospawn" "0"
            "spawnflags" "-1073741824"
            "origin" "-201 -3968 107"
        }
        "item_ammo_ar2"
        {
            "angles" "0 288.5 90"
            "disableshadows" "0"
            "fademaxdist" "0"
            "fademindist" "-1"
            "fadescale" "1"
            "minplayerstospawn" "0"
            "spawnflags" "-1073741824"
            "origin" "-196 -3983 107"
        }
        "prop_dynamic_override"
        {
            "angles" "-16.7845 103.262 99.404"
            "disablereceiveshadows" "0"
            "disableshadows" "0"
            "ExplodeDamage" "0"
            "ExplodeRadius" "0"
            "fademaxdist" "0"
            "fademindist" "-1"
            "fadescale" "1"
            "health" "0"
            "MaxAnimTime" "10"
            "maxdxlevel" "0"
            "MinAnimTime" "5"
            "mindxlevel" "0"
            "model" "models/props_wasteland/rockgranite02a.mdl"
            "PerformanceMode" "0"
            "pressuredelay" "0"
            "RandomAnimation" "0"
            "renderamt" "255"
            "rendercolor" "255 255 255"
            "renderdist" "0"
            "renderfx" "0"
            "rendermode" "0"
            "SetBodyGroup" "0"
            "skin" "0"
            "solid" "6"
            "spawnflags" "0"
            "origin" "-235 -3995 101"
        }
        "prop_dynamic_override"
        {
            "angles" "55.6263 112.893 122.513"
            "disablereceiveshadows" "0"
            "disableshadows" "0"
            "ExplodeDamage" "0"
            "ExplodeRadius" "0"
            "fademaxdist" "0"
            "fademindist" "-1"
            "fadescale" "1"
            "health" "0"
            "MaxAnimTime" "10"
            "maxdxlevel" "0"
            "MinAnimTime" "5"
            "mindxlevel" "0"
            "model" "models/props_wasteland/rockgranite02a.mdl"
            "PerformanceMode" "0"
            "pressuredelay" "0"
            "RandomAnimation" "0"
            "renderamt" "255"
            "rendercolor" "255 255 255"
            "renderdist" "0"
            "renderfx" "0"
            "rendermode" "0"
            "SetBodyGroup" "0"
            "skin" "0"
            "solid" "6"
            "spawnflags" "0"
            "origin" "-224 -4021 151"
        }
        "prop_dynamic_override"
        {
            "angles" "-4.69808 207.147 -162.507"
            "disablereceiveshadows" "0"
            "disableshadows" "0"
            "ExplodeDamage" "0"
            "ExplodeRadius" "0"
            "fademaxdist" "0"
            "fademindist" "-1"
            "fadescale" "1"
            "health" "0"
            "MaxAnimTime" "10"
            "maxdxlevel" "0"
            "MinAnimTime" "5"
            "mindxlevel" "0"
            "model" "models/props_wasteland/rockgranite02a.mdl"
            "PerformanceMode" "0"
            "pressuredelay" "0"
            "RandomAnimation" "0"
            "renderamt" "255"
            "rendercolor" "255 255 255"
            "renderdist" "0"
            "renderfx" "0"
            "rendermode" "0"
            "SetBodyGroup" "0"
            "skin" "0"
            "solid" "6"
            "spawnflags" "0"
            "origin" "-184 -3885 110"
        }
        "shadow_control"
        {
            "angles" "0 0 0"
            "color" "128 128 128"
            "disableallshadows" "0"
            "distance" "75"
            "origin" "-11281 -10614.4 70"
        }   
]]
MODIFY_MODIFY = [[
        {
            "-1621.3 -5914 128"
            {
                "origin" "-1703 -5908 128"
            }
        }  
]]

if (SERVER) then
    MAPCHECKPOINTS = MAPCHECKPOINTS or {
        ["Checkpoint_1"] = {},
        ["Checkpoint_2"] = {},  
    }
    CURRENT_CHECKPOINT = "Checkpoint_1"

    local blacklist = {       
        "weapon_scripted",
    }

    hook.Add("InitPostEntity", "oc_fireteam_1", function(player)
        for k, v in ipairs(ents.GetAll()) do
            if (MAPCHECKPOINTS[v:GetName()]) then
                if (v and v:IsValid()) then
                    table.insert(MAPCHECKPOINTS[v:GetName()], v)
                end
            end
        end

        local spawner = parseString(MODIFY_ADD:gsub("\t", ""))
        for k, v in ipairs(spawner) do
            local classname = v[1]
            local keyvalues = v[2]
            
            if (table.HasValue(blacklist, classname)) then
                continue
            end

            SOLID = nil
            if (classname == "prop_dynamic_override") then
                classname = "prop_physics"
                SOLID = true
            end

            if (classname == "prop_physics_override") then
                classname = "prop_physics"
                --SOLID = true
            end

            --if (true) then continue end

            local entity = ents.Create(classname)
            if (entity and entity:IsValid()) then
                for _, v in pairs(keyvalues) do
                    key = v[1]
                    val = v[2]
                    entity:SetKeyValue(key, val)

                    if key == "origin" then
                        local aots = string.Explode( " ", val)
                        entity:SetPos(Vector(aots[1], aots[2], aots[3]))
                    elseif key == "angles" then
                        local aots = string.Explode( " ", val)
                        entity:SetAngles(Angle(aots[1], aots[2], aots[3]))
                    elseif key == "model" then
                        entity:SetModel(val)
                    end

                    if (SOLID) then
                        timer.Simple(0, function()
                            if (entity and entity:IsValid()) then 
                                entity:SetMoveType(MOVETYPE_NONE)

                                local phys = entity:GetPhysicsObject()

                                if phys and phys:IsValid() then
                                    phys:Sleep()
                                    phys:EnableMotion(true)
                                end
                            end
                        end)
                    end

                end

                entity:Spawn()
            end
        end

    end)

    hook.Add("OnEntityTriggered", "custom_map", function(inputName, activator, data)
        if (inputName == "Spawn") then
            CURRENT_CHECKPOINT = data
        end
    end)

    hook.Add("EntityKeyValue", "oc_fireteam_1", function(entity, key, value)
        if (value:find("Checkpoint_1,Disable,,0,1")) then
            entity:SetKeyValue("OnTrigger", "hooker,Spawn,Checkpoint_2,0,-1")      
        end
    end)

    hook.Add("MapSpawnPoint", "oc_fireteam_1", function(player)
        local point = table.Random(MAPCHECKPOINTS[CURRENT_CHECKPOINT])
        while (!point:IsValid()) do
            point = table.Random(MAPCHECKPOINTS[CURRENT_CHECKPOINT])
        end

        return point
    end)
end
